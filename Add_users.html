<!DOCTYPE html>
<html lang="sl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administracija uporabnikov</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 50%, #374151 100%);
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
        color: #1a202c;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(20px);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 40px 32px;
        text-align: center;
        position: relative;
      }

      .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 8px;
        position: relative;
        z-index: 1;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 400;
        position: relative;
        z-index: 1;
      }

      .content {
        padding: 40px 32px;
      }

      .auth-check {
        background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
        color: #c53030;
        padding: 16px 20px;
        border-radius: 12px;
        margin-bottom: 32px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        border-left: 4px solid #e53e3e;
      }

      .form-section {
        margin-bottom: 32px;
      }

      .form-group {
        margin-bottom: 24px;
      }

      .form-label {
        display: block;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .select-wrapper {
        position: relative;
      }

      .select-wrapper::after {
        content: '\f107';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #718096;
        pointer-events: none;
        font-size: 1.1rem;
      }

      select {
        width: 100%;
        padding: 16px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 500;
        background: white;
        color: #2d3748;
        transition: all 0.3s ease;
        appearance: none;
        cursor: pointer;
      }

      select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        transform: translateY(-1px);
      }

      select:hover {
        border-color: #cbd5e0;
      }

      .access-display {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        padding: 24px;
        border-radius: 16px;
        margin: 32px 0;
        box-shadow: 0 10px 25px rgba(72, 187, 120, 0.2);
        position: relative;
        overflow: hidden;
      }

      .access-display::before {
        content: '\f023';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 3rem;
        opacity: 0.1;
      }

      .access-display h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .access-display h3::before {
        content: '\f058';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
      }

      .access-controls {
        background: #f7fafc;
        padding: 32px;
        border-radius: 20px;
        margin-top: 32px;
        border: 1px solid #e2e8f0;
      }

      .controls-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e2e8f0;
      }

      .controls-header h3 {
        font-size: 1.3rem;
        font-weight: 600;
        color: #2d3748;
      }

      .controls-header i {
        color: #3b82f6;
        font-size: 1.4rem;
      }

      .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 24px 0;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: white;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .checkbox-item:hover {
        border-color: #3b82f6;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
      }

      .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: #3b82f6;
        cursor: pointer;
      }

      .checkbox-item label {
        font-weight: 500;
        color: #2d3748;
        cursor: pointer;
        flex: 1;
      }

      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-top: 32px;
      }

      .btn {
        padding: 16px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn-primary {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
      }

      .btn-danger {
        background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
      }

      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(245, 101, 101, 0.4);
      }

      .message {
        padding: 16px 20px;
        border-radius: 12px;
        margin-top: 20px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideIn 0.3s ease;
      }

      .message.success {
        background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
        color: #22543d;
        border-left: 4px solid #48bb78;
      }

      .message.error {
        background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
        color: #c53030;
        border-left: 4px solid #e53e3e;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 16px;
        }

        .container {
          border-radius: 16px;
        }

        .header {
          padding: 32px 24px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .content {
          padding: 24px;
        }

        .checkbox-group {
          grid-template-columns: 1fr;
        }

        .button-group {
          grid-template-columns: 1fr;
        }

        .access-controls {
          padding: 24px;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 1.75rem;
        }

        .content {
          padding: 20px;
        }

        .access-controls {
          padding: 20px;
        }
      }

      .card-group {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 20px;
        margin: 32px 0;
        justify-content: center;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .access-card {
        min-width: 180px;
        max-width: 240px;
        flex: 1 1 180px;
        box-sizing: border-box;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 4px 18px 0 rgba(59,130,246,0.08), 0 1.5px 6px 0 rgba(0,0,0,0.04);
        padding: 18px 10px 16px 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1.5px solid #e5e7eb;
        transition: box-shadow 0.18s, border 0.18s, transform 0.18s, background 0.18s;
        cursor: pointer;
        position: relative;
      }
      .access-card:hover {
        box-shadow: 0 8px 32px 0 rgba(59,130,246,0.16), 0 2px 8px 0 rgba(0,0,0,0.06);
        border: 1.5px solid #3b82f6;
        background: linear-gradient(135deg, #f0f7ff 60%, #e0e7ff 100%);
      }
      .access-card.selected {
        box-shadow: 0 8px 32px 0 rgba(59,130,246,0.18), 0 0 0 4px #e0e7ff;
        background: linear-gradient(135deg, #f0f7ff 60%, #e0e7ff 100%);
        border: 2.5px solid #3b82f6;
      }
      .access-card i {
        margin-bottom: 14px;
      }
      .access-card div[style*='font-weight:600'] {
        margin-bottom: 10px !important;
        font-size: 1.18rem !important;
      }
      .access-card div[style*='font-size:0.97rem'] {
        color: #475569 !important;
        font-size: 1.01rem !important;
      }
      @media (max-width: 900px) {
        .card-group {
          flex-wrap: nowrap;
        }
      }
      @media (max-width: 600px) {
        .card-group {
          flex-direction: column;
          flex-wrap: nowrap;
          gap: 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-users-cog"></i> Administracija uporabnikov</h1>
        <p>Upravljajte dostope in dovoljenja za projekte</p>
      </div>
      <div class="content">
        <div class="form-section" id="userSection">
          <div class="form-group">
            <label for="userSelect" class="form-label">
              <i class="fas fa-user"></i> Izberi uporabnika
            </label>
            <div class="select-wrapper">
              <select id="userSelect">
                <option value="" disabled selected>Izberi uporabnika...</option>
              </select>
            </div>
          </div>
        </div>
        <div class="form-section" id="cardSection" style="display:none;">
          <label class="form-label"><i class="fas fa-key"></i> Izberi vrsto dostopa</label>
          <div class="card-group" style="display: flex; gap: 24px; margin: 24px 0; flex-wrap: wrap;">
            <div class="access-card" id="cardFullAccess" tabindex="0">
              <i class="fas fa-lock-open" style="font-size:2rem; color:#38a169; margin-bottom:12px;"></i>
              <div style="font-weight:600; font-size:1.1rem; margin-bottom:8px;">Popolni dostop</div>
              <div style="font-size:0.97rem; color:#4b5563; text-align:center;">Uporabnik ima branje in spreminjanje za vse projekte.</div>
            </div>
            <div class="access-card" id="cardReadAllWriteManual" tabindex="0">
              <i class="fas fa-eye" style="font-size:2rem; color:#3b82f6; margin-bottom:12px;"></i>
              <div style="font-weight:600; font-size:1.1rem; margin-bottom:8px;">Vsi projekti: ogled, ročno: spreminjanje</div>
              <div style="font-size:0.97rem; color:#4b5563; text-align:center;">Uporabnik ima ogled za vse projekte, spreminjanje pa nastavite ročno.</div>
            </div>
            <div class="access-card" id="cardManualBoth" tabindex="0">
              <i class="fas fa-sliders-h" style="font-size:2rem; color:#f59e42; margin-bottom:12px;"></i>
              <div style="font-weight:600; font-size:1.1rem; margin-bottom:8px;">Ročno: ogled in spreminjanje</div>
              <div style="font-size:0.97rem; color:#4b5563; text-align:center;">Za vsak projekt posebej nastavite ogled in spreminjanje.</div>
            </div>
          </div>
        </div>
        <div id="message" style="margin-bottom:20px;"></div>
        <div id="fullAccessConfirm" style="display:none; text-align:center; margin-bottom:20px;">
          <button id="fullAccessSaveBtn" class="btn btn-primary"><i class="fas fa-save"></i> Shrani popolni dostop</button>
        </div>
        <div id="customAccessSection" style="display:none;"></div>
      </div>
    </div>
    <script>
      let users = [];
      let projects = [];
      let accessLinks = [];
      const userSelect = document.getElementById("userSelect");
      const cardSection = document.getElementById("cardSection");
      const cardFullAccess = document.getElementById("cardFullAccess");
      const cardReadAllWriteManual = document.getElementById("cardReadAllWriteManual");
      const cardManualBoth = document.getElementById("cardManualBoth");
      const messageDiv = document.getElementById("message");
      const customAccessSection = document.getElementById("customAccessSection");
      const fullAccessConfirm = document.getElementById("fullAccessConfirm");
      const fullAccessSaveBtn = document.getElementById("fullAccessSaveBtn");
      let selectedUserId = null;
      // Load users and projects
      Promise.all([
        fetch('users.json').then(r => r.json()),
        fetch('projects.json').then(r => r.json())
      ]).then(([usersData, projectsData]) => {
        users = usersData;
        projects = projectsData;
        users.forEach((user) => {
          const option = document.createElement("option");
          option.value = user.id;
          option.textContent = user.name;
          userSelect.appendChild(option);
        });
      });
      userSelect.addEventListener("change", function() {
        selectedUserId = parseInt(userSelect.value);
        cardSection.style.display = selectedUserId ? 'block' : 'none';
        messageDiv.innerHTML = '';
        customAccessSection.style.display = 'none';
        customAccessSection.innerHTML = '';
        [cardFullAccess, cardReadAllWriteManual, cardManualBoth].forEach(c => c.classList.remove('selected'));
      });
      // Card 1: Full access
      cardFullAccess.addEventListener('click', function() {
        if (!selectedUserId) return;
        [cardFullAccess, cardReadAllWriteManual, cardManualBoth].forEach(c => c.classList.remove('selected'));
        cardFullAccess.classList.add('selected');
        messageDiv.innerHTML = '';
        customAccessSection.style.display = 'none';
        customAccessSection.innerHTML = '';
        fullAccessConfirm.style.display = 'block';
      });
      // --- Separate UI for Card 2: Vsi projekti: ogled, ročno: spreminjanje ---
      function renderReadAllWriteManualUI() {
        customAccessSection.innerHTML = `
          <div id='projectSelectContainerReadAllWriteManual'>
            <div style='margin-bottom:18px;'>
              <label style='font-weight:600;'>Izberi projekte za spreminjanje (write):</label><br>
              <input type='text' id='projectSearchReadAllWriteManual' placeholder='Išči projekte...' style='width:100%;padding:10px 14px;border-radius:8px;border:1.5px solid #cbd5e1;margin-top:8px;'>
              <div id='projectDropdownReadAllWriteManual' style='display:none;position:relative;z-index:10;background:#fff;border:1.5px solid #cbd5e1;border-radius:8px;max-height:180px;overflow-y:auto;margin-top:2px;'></div>
              <div id='selectedProjectsReadAllWriteManual' style='margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;'></div>
            </div>
            <form id="writeAccessFormReadAllWriteManual"><div id='writePermsListReadAllWriteManual' style='display:grid;gap:16px;'></div><button type="submit" class="btn btn-primary" style="margin-top:18px;"><i class="fas fa-save"></i> Shrani spremembe</button></form>
          </div>
        `;
        const projectSearch = document.getElementById('projectSearchReadAllWriteManual');
        const projectDropdown = document.getElementById('projectDropdownReadAllWriteManual');
        const selectedProjectsDiv = document.getElementById('selectedProjectsReadAllWriteManual');
        const writePermsList = document.getElementById('writePermsListReadAllWriteManual');
        let selectedProjectIds = [];
        accessLinks.filter(l => l.user_id === selectedUserId && l.access.includes('w')).forEach(l => {
          if (!selectedProjectIds.includes(l.project_id)) selectedProjectIds.push(l.project_id);
        });
        function renderDropdown(filter = '') {
          let filtered = projects.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()) && !selectedProjectIds.includes(p.id));
          if (filtered.length === 0) {
            projectDropdown.innerHTML = `<div style='padding:8px 12px;color:#888;'>Ni rezultatov</div>`;
            return;
          }
          projectDropdown.innerHTML = filtered.map(p => `<div class='dropdown-item' data-id='${p.id}' style='padding:8px 12px;cursor:pointer;'>${p.name}</div>`).join('');
        }
        function renderSelectedProjects() {
          selectedProjectsDiv.innerHTML = selectedProjectIds.map(pid => {
            const proj = projects.find(p => p.id === pid);
            return `<span class='selected-proj' data-id='${pid}' style='background:#e0e7ff;padding:6px 12px;border-radius:6px;display:inline-flex;align-items:center;gap:6px;'>${proj.name}<i class='fas fa-times' style='cursor:pointer;font-size:0.95em;'></i></span>`;
          }).join('');
          renderWritePerms();
        }
        function renderWritePerms() {
          if (selectedProjectIds.length === 0) {
            writePermsList.innerHTML = '';
            return;
          }
          let allHaveWrite = selectedProjectIds.every(pid => {
            const link = accessLinks.find(l => l.user_id === selectedUserId && l.project_id === pid);
            return link && link.access.includes('w');
          });
          writePermsList.innerHTML = `
            <div style='display:flex;align-items:center;gap:24px;padding:12px 0;'>
              <label style='display:flex;align-items:center;gap:6px;'><input type='checkbox' checked disabled style='accent-color:#3b82f6;'> Ogled (read)</label>
              <label style='display:flex;align-items:center;gap:6px;'><input type='checkbox' id='writeAllSelectedReadAllWriteManual' ${allHaveWrite ? 'checked' : ''} style='accent-color:#3b82f6;'> Spreminjanje (write)</label>
            </div>
          `;
        }
        projectSearch.addEventListener('focus', function() {
          renderDropdown(projectSearch.value);
          projectDropdown.style.display = 'block';
        });
        projectSearch.addEventListener('input', function() {
          renderDropdown(projectSearch.value);
          projectDropdown.style.display = 'block';
        });
        projectDropdown.addEventListener('mousedown', function(e) {
          if (e.target.classList.contains('dropdown-item')) {
            const pid = parseInt(e.target.getAttribute('data-id'));
            if (!selectedProjectIds.includes(pid)) {
              selectedProjectIds.push(pid);
              renderSelectedProjects();
              projectSearch.value = '';
              renderDropdown('');
            }
          }
        });
        selectedProjectsDiv.addEventListener('mousedown', function(e) {
          if (e.target.classList.contains('fa-times')) {
            const parent = e.target.closest('.selected-proj');
            const pid = parseInt(parent.getAttribute('data-id'));
            selectedProjectIds = selectedProjectIds.filter(id => id !== pid);
            renderSelectedProjects();
            renderDropdown(projectSearch.value);
          }
        });
        renderSelectedProjects();
        renderDropdown('');
        document.getElementById('writeAccessFormReadAllWriteManual').onsubmit = function(e) {
          e.preventDefault();
          accessLinks = accessLinks.filter(link => link.user_id !== selectedUserId);
          const writeChecked = document.getElementById('writeAllSelectedReadAllWriteManual') && document.getElementById('writeAllSelectedReadAllWriteManual').checked;
          projects.forEach(project => {
            let access = ['r'];
            if (selectedProjectIds.includes(project.id) && writeChecked) {
              access.push('w');
            }
            accessLinks.push({ user_id: selectedUserId, project_id: project.id, access });
          });
          window.location.href = 'access_saved.html';
        };
      }
      // --- Separate UI for Card 3: Ročno: ogled in spreminjanje ---
      function renderManualBothAccessUI() {
        customAccessSection.innerHTML = `
          <div id='projectSelectContainerManualBoth'>
            <div style='margin-bottom:18px;'>
              <label style='font-weight:600;'>Izberi projekte za ogled in/ali spreminjanje:</label><br>
              <input type='text' id='projectSearchManualBoth' placeholder='Išči projekte...' style='width:100%;padding:10px 14px;border-radius:8px;border:1.5px solid #cbd5e1;margin-top:8px;'>
              <div id='projectDropdownManualBoth' style='display:none;position:relative;z-index:10;background:#fff;border:1.5px solid #cbd5e1;border-radius:8px;max-height:180px;overflow-y:auto;margin-top:2px;'></div>
              <div id='selectedProjectsManualBoth' style='margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;'></div>
            </div>
            <form id="writeAccessFormManualBoth"><div id='writePermsListManualBoth' style='display:grid;gap:16px;'></div><button type="submit" class="btn btn-primary" style="margin-top:18px;"><i class="fas fa-save"></i> Shrani spremembe</button></form>
          </div>
        `;
        const projectSearch = document.getElementById('projectSearchManualBoth');
        const projectDropdown = document.getElementById('projectDropdownManualBoth');
        const selectedProjectsDiv = document.getElementById('selectedProjectsManualBoth');
        const writePermsList = document.getElementById('writePermsListManualBoth');
        let selectedProjectIds = [];
        accessLinks.filter(l => l.user_id === selectedUserId).forEach(l => {
          if (!selectedProjectIds.includes(l.project_id)) selectedProjectIds.push(l.project_id);
        });
        function renderDropdown(filter = '') {
          let filtered = projects.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()) && !selectedProjectIds.includes(p.id));
          if (filtered.length === 0) {
            projectDropdown.innerHTML = `<div style='padding:8px 12px;color:#888;'>Ni rezultatov</div>`;
            return;
          }
          projectDropdown.innerHTML = filtered.map(p => `<div class='dropdown-item' data-id='${p.id}' style='padding:8px 12px;cursor:pointer;'>${p.name}</div>`).join('');
        }
        function renderSelectedProjects() {
          selectedProjectsDiv.innerHTML = selectedProjectIds.map(pid => {
            const proj = projects.find(p => p.id === pid);
            return `<span class='selected-proj' data-id='${pid}' style='background:#e0e7ff;padding:6px 12px;border-radius:6px;display:inline-flex;align-items:center;gap:6px;'>${proj.name}<i class='fas fa-times' style='cursor:pointer;font-size:0.95em;'></i></span>`;
          }).join('');
          renderWritePerms();
        }
        function renderWritePerms() {
          if (selectedProjectIds.length === 0) {
            writePermsList.innerHTML = '';
            return;
          }
          // Determine if all selected projects have read and write access
          let allHaveRead = selectedProjectIds.every(pid => {
            const link = accessLinks.find(l => l.user_id === selectedUserId && l.project_id === pid);
            return link && link.access.includes('r');
          });
          let allHaveWrite = selectedProjectIds.every(pid => {
            const link = accessLinks.find(l => l.user_id === selectedUserId && l.project_id === pid);
            return link && link.access.includes('w');
          });
          writePermsList.innerHTML = `
            <div style='display:flex;align-items:center;gap:24px;padding:12px 0;'>
              <label style='display:flex;align-items:center;gap:6px;'><input type='checkbox' id='readAllSelectedManualBoth' ${allHaveRead ? 'checked' : ''} style='accent-color:#3b82f6;'> Ogled (read)</label>
              <label style='display:flex;align-items:center;gap:6px;'><input type='checkbox' id='writeAllSelectedManualBoth' ${allHaveWrite ? 'checked' : ''} style='accent-color:#3b82f6;'> Spreminjanje (write)</label>
            </div>
          `;
        }
        projectSearch.addEventListener('focus', function() {
          renderDropdown(projectSearch.value);
          projectDropdown.style.display = 'block';
        });
        projectSearch.addEventListener('input', function() {
          renderDropdown(projectSearch.value);
          projectDropdown.style.display = 'block';
        });
        projectDropdown.addEventListener('mousedown', function(e) {
          if (e.target.classList.contains('dropdown-item')) {
            const pid = parseInt(e.target.getAttribute('data-id'));
            if (!selectedProjectIds.includes(pid)) {
              selectedProjectIds.push(pid);
              renderSelectedProjects();
              projectSearch.value = '';
              renderDropdown('');
            }
          }
        });
        selectedProjectsDiv.addEventListener('mousedown', function(e) {
          if (e.target.classList.contains('fa-times')) {
            const parent = e.target.closest('.selected-proj');
            const pid = parseInt(parent.getAttribute('data-id'));
            selectedProjectIds = selectedProjectIds.filter(id => id !== pid);
            renderSelectedProjects();
            renderDropdown(projectSearch.value);
          }
        });
        renderSelectedProjects();
        renderDropdown('');
        document.getElementById('writeAccessFormManualBoth').onsubmit = function(e) {
          e.preventDefault();
          accessLinks = accessLinks.filter(link => link.user_id !== selectedUserId);
          const readChecked = document.getElementById('readAllSelectedManualBoth') && document.getElementById('readAllSelectedManualBoth').checked;
          const writeChecked = document.getElementById('writeAllSelectedManualBoth') && document.getElementById('writeAllSelectedManualBoth').checked;
          projects.forEach(project => {
            if (selectedProjectIds.includes(project.id)) {
              let access = [];
              if (readChecked) access.push('r');
              if (writeChecked) access.push('w');
              if (access.length > 0) {
                accessLinks.push({ user_id: selectedUserId, project_id: project.id, access });
              }
            }
          });
          window.location.href = 'access_saved.html';
        };
      }
      // --- Card click handlers ---
      cardReadAllWriteManual.addEventListener('click', function() {
        if (!selectedUserId) return;
        [cardFullAccess, cardReadAllWriteManual, cardManualBoth].forEach(c => c.classList.remove('selected'));
        cardReadAllWriteManual.classList.add('selected');
        messageDiv.innerHTML = '';
        customAccessSection.style.display = 'block';
        renderReadAllWriteManualUI();
      });
      cardManualBoth.addEventListener('click', function() {
        if (!selectedUserId) return;
        [cardFullAccess, cardReadAllWriteManual, cardManualBoth].forEach(c => c.classList.remove('selected'));
        cardManualBoth.classList.add('selected');
        messageDiv.innerHTML = '';
        customAccessSection.style.display = 'block';
        renderManualBothAccessUI();
      });
      // Hide confirm if other card is clicked
      [cardReadAllWriteManual, cardManualBoth].forEach(card => {
        card.addEventListener('click', function() {
          fullAccessConfirm.style.display = 'none';
        });
      });
      // Save full access on confirm
      fullAccessSaveBtn.addEventListener('click', function() {
        if (!selectedUserId) return;
        // Remove all previous access for this user
        accessLinks = accessLinks.filter(link => link.user_id !== selectedUserId);
        // Grant r+w for all projects
        projects.forEach(project => {
          accessLinks.push({ user_id: selectedUserId, project_id: project.id, access: ["r", "w"] });
        });
        messageDiv.innerHTML = '<div class="message success"><i class="fas fa-check-circle"></i> Uporabnik ima popolni dostop do vseh projektov.</div>';
        fullAccessConfirm.style.display = 'none';
      });
    </script>
  </body>
</html>